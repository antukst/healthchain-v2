<!DOCTYPE html>
<html>
<head>
<title>Simple IPFS Test</title>
<style>
body { 
  font-family: Arial; 
  max-width: 800px; 
  margin: 50px auto; 
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}
.box { 
  background: white; 
  color: #333; 
  padding: 30px; 
  border-radius: 15px; 
  margin: 20px 0;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
button { 
  background: #667eea; 
  color: white; 
  border: none; 
  padding: 15px 30px; 
  font-size: 18px;
  border-radius: 8px; 
  cursor: pointer;
  font-weight: bold;
}
button:hover { background: #5568d3; }
#result { 
  margin-top: 20px; 
  padding: 20px; 
  border-radius: 8px;
  font-size: 16px;
}
.success { background: #d4edda; color: #155724; }
.error { background: #f8d7da; color: #721c24; }
.info { background: #d1ecf1; color: #0c5460; }
pre { 
  background: #f4f4f4; 
  padding: 15px; 
  border-radius: 5px; 
  overflow-x: auto;
  color: #333;
}
h1 { margin: 0 0 10px 0; }
</style>
</head>
<body>

<h1>üß™ IPFS Desktop Simple Test</h1>
<p>‡¶∏‡¶π‡¶ú CORS test - ‡¶ï‡ßã‡¶®‡ßã external library ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá ‡¶®‡¶æ</p>

<div class="box">
  <h2>Test 1: Direct API Call</h2>
  <button onclick="testDirectAPI()">üîç Test IPFS API</button>
  <div id="result1"></div>
</div>

<div class="box">
  <h2>Test 2: CORS Headers Check</h2>
  <button onclick="testCORS()">üåê Check CORS Headers</button>
  <div id="result2"></div>
</div>

<div class="box">
  <h2>Test 3: Upload Test Data</h2>
  <button onclick="testUpload()">üì§ Upload to IPFS</button>
  <div id="result3"></div>
</div>

<script>
console.log('üöÄ Page loaded successfully');

async function testDirectAPI() {
  const result = document.getElementById('result1');
  result.className = 'info';
  result.innerHTML = 'üîÑ Testing...';
  
  console.log('Testing IPFS API at http://127.0.0.1:5001/api/v0/version');
  
  try {
    const response = await fetch('http://127.0.0.1:5001/api/v0/version', {
      method: 'POST'
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', [...response.headers.entries()]);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('‚úÖ Success! IPFS version:', data);
    
    result.className = 'success';
    result.innerHTML = `
      <h3>‚úÖ IPFS Desktop Connected!</h3>
      <strong>Version:</strong> ${data.Version}<br>
      <strong>Commit:</strong> ${data.Commit || 'N/A'}<br>
      <strong>Repo:</strong> ${data.Repo}<br>
      <strong>System:</strong> ${data.System}<br>
      <strong>Golang:</strong> ${data.Golang}<br><br>
      <strong style="color: green;">CORS ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá! ‚úÖ</strong>
    `;
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    result.className = 'error';
    result.innerHTML = `
      <h3>‚ùå Connection Failed</h3>
      <strong>Error:</strong> ${error.message}<br><br>
      ${error.message.includes('Failed to fetch') ? `
        <strong>‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:</strong> CORS blocked ‡¶Ö‡¶•‡¶¨‡¶æ IPFS Desktop ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶®‡ßá‡¶á<br><br>
        <strong>‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®:</strong><br>
        1. IPFS Desktop ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ check ‡¶ï‡¶∞‡ßã<br>
        2. CORS config add ‡¶ï‡¶∞‡ßá‡¶õ‡ßã ‡¶ï‡¶ø‡¶®‡¶æ verify ‡¶ï‡¶∞‡ßã<br>
        3. IPFS Desktop restart ‡¶ï‡¶∞‡ßã<br>
        4. ‡¶è‡¶á page refresh ‡¶ï‡¶∞‡ßã (Ctrl+Shift+R)
      ` : ''}
    `;
  }
}

async function testCORS() {
  const result = document.getElementById('result2');
  result.className = 'info';
  result.innerHTML = 'üîÑ Checking CORS headers...';
  
  try {
    const response = await fetch('http://127.0.0.1:5001/api/v0/version', {
      method: 'POST'
    });
    
    const corsHeaders = {
      'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
      'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
      'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
    };
    
    console.log('CORS Headers:', corsHeaders);
    
    result.className = 'success';
    result.innerHTML = `
      <h3>‚úÖ CORS Headers Present</h3>
      <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
      <strong style="color: green;">CORS configuration ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá!</strong>
    `;
    
  } catch (error) {
    result.className = 'error';
    result.innerHTML = `
      <h3>‚ùå Cannot check CORS</h3>
      Error: ${error.message}<br><br>
      IPFS Desktop ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶®‡ßá‡¶á ‡¶Ö‡¶•‡¶¨‡¶æ CORS config ‡¶®‡ßá‡¶á‡•§
    `;
  }
}

async function testUpload() {
  const result = document.getElementById('result3');
  result.className = 'info';
  result.innerHTML = 'üîÑ Uploading test data...';
  
  try {
    const testData = JSON.stringify({
      test: 'HealthChain IPFS Test',
      timestamp: new Date().toISOString(),
      message: '‡¶è‡¶ü‡¶æ ‡¶è‡¶ï‡¶ü‡¶æ test upload'
    });
    
    const formData = new FormData();
    formData.append('file', new Blob([testData], {type: 'application/json'}), 'test.json');
    
    const response = await fetch('http://127.0.0.1:5001/api/v0/add?pin=true', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Upload failed: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('‚úÖ Upload successful:', data);
    
    // Now copy to MFS (Files tab) so it's visible in IPFS Desktop
    const cid = data.Hash;
    const mfsPath = `/healthchain/test_${Date.now()}.json`;
    
    try {
      // Create /healthchain directory
      await fetch('http://127.0.0.1:5001/api/v0/files/mkdir?arg=' + encodeURIComponent('/healthchain') + '&parents=true', {
        method: 'POST'
      });
      
      // Copy to MFS
      await fetch('http://127.0.0.1:5001/api/v0/files/cp?arg=' + encodeURIComponent(`/ipfs/${cid}`) + '&arg=' + encodeURIComponent(mfsPath), {
        method: 'POST'
      });
      
      console.log('‚úÖ Copied to MFS:', mfsPath);
      
      result.className = 'success';
      result.innerHTML = `
        <h3>‚úÖ Upload Successful!</h3>
        <strong>CID:</strong> ${data.Hash}<br>
        <strong>Name:</strong> ${data.Name}<br>
        <strong>Size:</strong> ${data.Size} bytes<br>
        <strong>MFS Path:</strong> ${mfsPath}<br><br>
        <strong style="color: green;">‚úÖ ‡¶è‡¶ñ‡¶® IPFS Desktop ‚Üí Files tab ‚Üí /healthchain/ folder ‡¶è ‡¶¶‡ßá‡¶ñ‡ßã!</strong><br><br>
        Gateway link: <a href="https://ipfs.io/ipfs/${data.Hash}" target="_blank">https://ipfs.io/ipfs/${data.Hash}</a>
      `;
      
    } catch (mfsError) {
      console.warn('‚ö†Ô∏è MFS copy failed:', mfsError);
      result.className = 'success';
      result.innerHTML = `
        <h3>‚ö†Ô∏è Partial Success</h3>
        <strong>CID:</strong> ${data.Hash}<br>
        <strong>Size:</strong> ${data.Size} bytes<br><br>
        File uploaded ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ Files tab ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§<br>
        MFS Error: ${mfsError.message}<br><br>
        Gateway link: <a href="https://ipfs.io/ipfs/${data.Hash}" target="_blank">https://ipfs.io/ipfs/${data.Hash}</a>
      `;
    }
    
  } catch (error) {
    console.error('‚ùå Upload error:', error);
    result.className = 'error';
    result.innerHTML = `
      <h3>‚ùå Upload Failed</h3>
      Error: ${error.message}
    `;
  }
}

// Auto-run test on page load
window.addEventListener('load', () => {
  console.log('Running auto-test in 2 seconds...');
  setTimeout(() => {
    console.log('Starting automatic IPFS test...');
    testDirectAPI();
  }, 2000);
});
</script>

</body>
</html>
